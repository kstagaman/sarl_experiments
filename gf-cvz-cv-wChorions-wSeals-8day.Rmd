---
title: "Zebrafish behavior"
output: html_document
---
#### Comparing Germ-free, Conventionalized, and Conventional Zebrafish in Sealed 96-well Plates

```{r setup, include=FALSE}
# wds <- c("~/Google Drive/OSU/OSU_Home_Sync", "~/Google Drive/OSU_Home_Sync")
# my.wd <- list.files(path = wds, pattern = "SARL Experiments", full.names = T)
# setwd(my.wd)

source("~/Code/R_scripts/require_lot_of_packages.R")
libs <- c("data.table", "magrittr", "ggplot2", "cowplot", "ggbeeswarm", "caTools", "FSA", "ggsignif", "kableExtra")
require.lots.of.pkgs(libs)
source("~/Code/R_scripts/mgsub.R")

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

treat.code <- c("germ-free" = "GF", "conventionalized" = "CVZ", "conventional" = "CV")
expt.log <- read.csv("SARL Experiment Log.csv") %>% as.data.table()
expt.log[, Treatment := treat.code[as.character(Plate_description)]]
setkey(expt.log, Plate_ID)
plate.treat <- expt.log[, .(Plate_ID, Treatment)]

dir.pattern <- "gf-cvz-cv-wChorions-wSeals-8day-01"
dirs <- list.files(pattern = dir.pattern)

sig.stars <- function(x) {
  ifelse(
    x < 0.0001, "***", 
    ifelse(
      x < 0.001, "**", 
      ifelse(
        x < 0.01, "**", 
        ifelse(
          x < 0.05, "*", "n.s."
        )
      )
    )
  )
}
sig.vals <- function(x, a = 3) {
  paste("p =", round(x, a))
}

```

### Day 1 - HMAT

```{r hmat-all-movement-plot, fig.cap="Red lines indicate the window of movement we will analyze statistically"}
hmat.pattern <- "behavior_24h_FOR_GUI_HMAT_With_Removal"
hmat.path <- file.path(dirs, "GUI files", "RemovedAffected")
hmat.files <- list.files(path = hmat.path, pattern = hmat.pattern, full.names = T)
hmat.data <- do.call('rbindlist', list(l = lapply(hmat.files, read.csv), fill = TRUE)) %>% as.data.table()
hmat.data <- hmat.data[remove == 0]
hmat.data <- hmat.data[plate.treat, on = "plate.id==Plate_ID", nomatch = 0]
idVars <- names(hmat.data)[!(grepl("^t", names(hmat.data)))]
hmat.melt <- melt(hmat.data, id.vars = idVars)
hmat.melt[, variable := as.numeric(gsub("t", "", variable))]
hmat.melt[, plate.id := factor(plate.id)]
hmat.melt[, Treatment := factor(Treatment, levels = c("GF", "CVZ", "CV"))]

ggplot(hmat.melt, aes(x = variable, y = value)) +
  geom_vline(xintercept = c(30, 40), color = "red", size = 0.3) +
  stat_summary(
    fun.data = "mean_cl_boot", 
    geom = "ribbon", 
    aes(group = Treatment, fill = Treatment), 
    alpha = 0.2
  ) + 
  stat_summary(fun.y = mean, geom = "line", aes(group = Treatment, color = Treatment)) +
  coord_cartesian(xlim = c(21, 48)) +
  scale_color_brewer(name = "Treatment", palette = "Dark2") +
  scale_fill_brewer(name = "Treatment", palette = "Dark2") + 
  labs(x = "Time", y = "Movement [ÂµM]", title = "HMAT Results") + 
  theme(legend.position = "top")
```

```{r hmat-auc-stats, fig.cap="Post-hoc pairwise comparisons conducted with Dunn's Kruskal-Wallis Multiple Comparisons Test with False Discovery Rate"}
window.data <- hmat.melt[variable > 29 & variable < 41]
aucs <- window.data[
  ,
  .(
    AUC = caTools::trapz(x = variable, y = value)
  ),
  by = c("well", "plate.id", "Treatment")
  ]
kw <- kruskal.test(AUC ~ Treatment, data = aucs)
# print(kw)

if (kw$p.value < 0.05) {
  dunn <- FSA::dunnTest(AUC ~ Treatment, data = aucs, method = "bh") 
  # print(dunn)
  dunn.dt <- as.data.table(dunn$res)
  dunn.dt[, c("Start", "End") := tstrsplit(Comparison, " - ", fixed = TRUE)]
  dunn.dt[, Label := sig.vals(P.adj)]
  dunn.dt[, Y := c(265, 295, 230)]
}
kw.lab <- paste0(names(kw$statistic), " = ", round(kw$statistic, 3), ", df = ", kw$parameter, ", p-value = ", round(kw$p.value, 3))

ggplot(aucs) +
  geom_quasirandom(aes(x = Treatment, y = AUC, color = Treatment), dodge.width = 1) + 
  stat_summary(
    aes(x = Treatment, y = AUC),
    fun.data = "mean_cl_boot", 
    color = "black", 
    geom = "errorbar",
    position = position_dodge(width = 1), 
    width = 0.4
  ) + 
  scale_color_brewer(palette = "Dark2") + 
  geom_signif(
    data = dunn.dt,
    aes(xmin = Start, xmax = End, annotations = Label, y_position = Y),
    vjust = -0.2, textsize = 3,
    manual = TRUE
  ) + 
  annotate("text", x = 0.2, y = 370, hjust = 0, label = kw.lab, size = 3) + 
  coord_cartesian(ylim = c(0, 400)) + 
  labs(title = "Individual HMAT AUCs") + 
  theme(legend.position = "none")
```

```{r hmat-plot-with-plates, fig.cap="AUCS broken down by both plate and treatment"}
ggplot(aucs, aes(x = Treatment, y = AUC)) +
  geom_quasirandom(aes(color = plate.id), dodge.width = 1, show.legend = F) + 
  stat_summary(
    aes(group = interaction(Treatment, plate.id)),
    fun.data = "mean_cl_boot", 
    color = "black", 
    geom = "errorbar",
    position = position_dodge(width = 1), 
    width = 0.4
  ) + 
  scale_color_brewer(palette = "Paired") + 
  labs(title = "Individual HMAT AUCs") +
  theme(legend.position = "none")
```

```{r hmat-stats-with-plates}
aucs1 <- copy(aucs)
aucs1[
  , 
  plate.id.new := mgsub(
    c("18099", "18100", "18101", "18102", "18103", "18104"),
    c("1", "2", "1", "2", "1", "2"),
    plate.id
    )
  ]
kw <- kruskal.test(AUC ~ interaction(Treatment, plate.id), data = aucs)
print(kw)

if (kw$p.value < 0.05) {
  dunn <- FSA::dunnTest(AUC ~ interaction(Treatment, plate.id.new), data = aucs1, method = "bh") 
  dunn.dt <- as.data.table(dunn$res)
  dunn.dt[, `:=`(P.unadj = round(P.unadj, 3), P.adj = round(P.adj, 3))]
  # cat("Significant (P.adj < 0.05) pairwise comparisons:", sep = "\n")
  # cat("", sep = "\n")
  knitr::kable(dunn.dt[P.adj < 0.05], caption = "Significant (P.adj < 0.05) pairwise comparisons") %>%
    kable_styling(bootstrap_options = "striped")
  # dunn.dt[, Y := c(265, 295, 230)]
}
```

### Day 5 - LPR

```{r lpr-by-treatment-plot, fig.cap="LPR results from epoch 2 by Treatment. Yellow line indicates light cycle (vs dark cycle)"}
lpr.pattern <- "behavior_5d_FOR_GUI_LPR"
lpr.path <- file.path(dirs, "GUI files", "RemovedAffected")
lpr.files <- list.files(path = lpr.path, pattern = lpr.pattern, full.names = T)
lpr.data <- do.call("rbind", lapply(lpr.files, read.csv)) %>% as.data.table()
lpr.data <- lpr.data[complete.cases(lpr.data)]
lpr.data <- lpr.data[plate.treat, on = "plate==Plate_ID", nomatch = 0]
nSubjects.lpr <- lpr.data[, .(N = .N), by = c("Treatment", "plate")]
# write.table(nSubjects.lpr, file = "lpr_nSubjects_tbl.csv", sep = ",", quote = F, row.names = F)

behav5d <- lpr.data
behav5d$conc <- as.numeric(as.character(behav5d$conc))
### lets analyze only the 2nd epoch
l1 <- paste0("t", seq(61,89))
d1 <- paste0("t", seq(90,119))
lstart <- 61
dend <- 119
ep2 <- paste0("t", seq(lstart, dend))

### use guozhu's code
upper <- 0.95
lower <- 0.05
# test5d <- behav5d[which(behav5d$chemical.id == "C09375"),]
DE <- function(x) log(quantile(x, upper, na.rm = TRUE) - quantile(x, lower, na.rm = TRUE) + 1)
hcal <- melt(behav5d, id = c("Treatment", "chemical.id", "well", "conc", "plate"))
hcal <- hcal[, .(h = DE(value)), by = c("Treatment", "plate", "variable")]
hcal[, Treatment := factor(Treatment, levels = c("GF", "CVZ", "CV"))]

hcal2 <- hcal[variable %in% ep2]
hcal2 <- hcal2[, .(ave.h = mean(h)), by = c("Treatment", "plate", "variable")]
hcal2$time <- gsub("[a-zA-Z]", "\\2", hcal2$variable)
hcal2$time <- as.numeric(as.character(hcal2$time))
hcal3 <- hcal2
hcal3[, sec := (floor((time - 61) / 5)) * 30]

hcal4 <- hcal3[, .(h.sec = sum(ave.h)), by = c("Treatment", "sec")]
# hcal4[, Treatment := factor(Treatment, levels = c("GF", "CVZ", "CV"))]

ggplot(hcal4, aes(sec, h.sec, colour = Treatment)) +
  geom_path(lwd = 1.2, aes(group = Treatment)) +
  geom_segment(x = 0, y = 10, xend = 150, yend = 10, color = "yellow") + 
  scale_color_brewer(name = "Treatment", palette = "Dark2") +
  labs(x = "Time", y = "Differential Entropy") + 
  theme(legend.position = "top")
```

```{r lpr-stats}
l1 <- paste0("t", seq(61,89))
d1 <- paste0("t", seq(90,119))
lstart <- 61
lend <- 89
dstart <- 90
dend <- 119
ep2 <- paste0("t", seq(lstart,dend))
headers <- c(
  "Treatment",
  #"Week",
  "Light_Cycle_Pval",
  "Dark_Cycle_Pval",
  "Light_Cycle_AUC",
  "Dark_Cycle_AUC"
  #"Light_AUC_Ratio",
  # "Dark_AUC_Ratio",
  # "Light_AUC_RelativeRatio",
  # "Dark_AUC_RelativeRatio"
)
phases <- c("light", "dark")
hdata <- hcal
# fails <- temp_qc_fail[which(temp_qc_fail$Chemical.ID == chi),'conc']
treatments <- levels(hdata$Treatment)

some1 <- matrix(
  data = 0,
  nrow = length(treatments), 
  ncol = length(headers), 
  dimnames = list(1:length(treatments), headers)
  ) %>% as.data.table()
some1$Treatment <- treatments
setkey(some1, Treatment)
ctrl.treat <- "CV"
ctrl <- hdata[Treatment == ctrl.treat]

AUC.dt1 <- NULL
# (treat <- treatments[3])
for (treat in treatments) {
  hdata1 <- hdata[Treatment == treat]
  ##dark AUC
  #Kolmogorov-Smirnov Goodness-of-Fit
  ksdark <- suppressWarnings(
    ks.test(
      ctrl[variable %in% d1]$h,
      hdata1[variable %in% d1]$h, 
      alternative = "two.sided"
    )
  )
  some1[treat, "Dark_Cycle_Pval"] <- round(ksdark$p.value, 3)
  
  ##light AUC
  #Kolmogorov-Smirnov Goodness-of-Fit
  kslight <- suppressWarnings(
    ks.test(
      ctrl[variable %in% l1]$h,
      hdata1[variable %in% l1]$h, 
      alternative = "two.sided"
    )
  )
  
  some1[treat, "Light_Cycle_Pval"] <- round(kslight$p.value, 3)
  (phase <- phases[1])
  for (phase in phases) {
    if (phase == "light") {
      h1 <- paste0("t", lstart)
      hend <- paste0("t", lend)
      between <- paste0("t", seq(lstart + 1, lend - 1))
    } else {
      h1 <- paste0("t", dstart)
      hend <- paste0("t", dend)
      between <- paste0("t", seq(dstart + 1, dend - 1))
    }
    hdat <- hdata1[variable %in% c(h1,hend,between)]
    
    
    # for(pl in plates){
    #   hdat1 <- hdat %>% filter(plate == pl)
    
    hdat[, variable := as.numeric(gsub("[a-zA-Z]", "\\2", as.character(variable)))]
    auc <- caTools::trapz(hdat$variable, hdat$h)
    
    hcalc <- data.frame(treat, auc, phase)
    AUC.dt1 <- rbind(AUC.dt1, hcalc)
    if (phase == "dark") {
      some1[treat, "Dark_Cycle_AUC"] <- round(hcalc$auc,3) 
    }
    if (phase == "light") {
      some1[treat, "Light_Cycle_AUC"] <- round(hcalc$auc,3)    
    }
    # } ##plates   
  }##light phases
}

# AUC.ch1 <- AUC.ch %>% filter(c == co)
AUC.ch1.wide <- dcast(AUC.dt1, treat ~ phase, value.var = "auc") %>% as.data.table()
setkey(AUC.ch1.wide, treat)
relativeRatios <- AUC.ch1.wide[
  , 
  .(
    Treatment = treat,
    Light_AUC_RelativeRatio = (light - AUC.ch1.wide[ctrl.treat, light])/AUC.ch1.wide[ctrl.treat, light],
    Dark_AUC_RelativeRatio = (dark - AUC.ch1.wide[ctrl.treat, dark])/AUC.ch1.wide[ctrl.treat, dark]
    )
  ]
setkey(relativeRatios, Treatment)
some1 <- some1[relativeRatios]
setkey(some1, Treatment)
some1[ctrl.treat, "Treatment"] <- paste(some1[ctrl.treat, "Treatment"], "(Ctrl)")
knitr::kable(some1, caption = "Comparing GF and CVZ to CV") %>% 
  kable_styling(bootstrap_options = "striped")

######

no.cv <- treatments[-which(treatments == "CV")]
some2 <- matrix(
  data = 0,
  nrow = length(no.cv), 
  ncol = length(headers), 
  dimnames = list(1:length(no.cv), headers)
  ) %>% as.data.table()
some2$Treatment <- no.cv
setkey(some2, Treatment)
ctrl.treat <- "CVZ"
ctrl <- hdata[Treatment == ctrl.treat]

AUC.dt2 <- NULL
for (treat in no.cv) {
  hdata1 <- hdata[Treatment == treat]
  ##dark AUC
  #Kolmogorov-Smirnov Goodness-of-Fit
  ksdark <- suppressWarnings(
    ks.test(
      ctrl[variable %in% d1]$h,
      hdata1[variable %in% d1]$h, 
      alternative = "two.sided"
    )
  )
  some2[treat, "Dark_Cycle_Pval"] <- round(ksdark$p.value, 3)
  
  ##light AUC
  #Kolmogorov-Smirnov Goodness-of-Fit
  kslight <- suppressWarnings(
    ks.test(
      ctrl[variable %in% l1]$h,
      hdata1[variable %in% l1]$h, 
      alternative = "two.sided"
    )
  )
  
  some2[treat, "Light_Cycle_Pval"] <- round(kslight$p.value, 3)
  # phase <- phases[1]
  for (phase in phases) {
    if (phase == "light") {
      h1 <- paste0("t", lstart)
      hend <- paste0("t", lend)
      between <- paste0("t", seq(lstart + 1, lend - 1))
    } else {
      h1 <- paste0("t", dstart)
      hend <- paste0("t", dend)
      between <- paste0("t", seq(dstart + 1, dend - 1))
    }
    hdat <- hdata1[variable %in% c(h1,hend,between)]
    
    
    # for(pl in plates){
    #   hdat1 <- hdat %>% filter(plate == pl)
    
    hdat[, variable := as.numeric(gsub("[a-zA-Z]", "\\2", as.character(variable)))]
    auc <- caTools::trapz(hdat$variable, hdat$h)
    
    hcalc <- data.frame(treat, auc, phase)
    AUC.dt2 <- rbind(AUC.dt2, hcalc)
    if (phase == "dark") {
      some2[treat, "Dark_Cycle_AUC"] <- round(hcalc$auc,3) 
    }
    if (phase == "light") {
      some2[treat, "Light_Cycle_AUC"] <- round(hcalc$auc,3)    
    }
    # } ##plates   
  }##light phases
}

# AUC.ch1 <- AUC.ch %>% filter(c == co)
AUC.ch2.wide <- dcast(AUC.dt2, treat ~ phase, value.var = "auc") %>% as.data.table()
setkey(AUC.ch2.wide, treat)
some2[as.character(AUC.ch2.wide$treat), c("Light_AUC_RelativeRatio", "Dark_AUC_RelativeRatio")] <- AUC.ch2.wide[
  , 
  .(
    LRratio = (light - AUC.ch2.wide[ctrl.treat, light])/AUC.ch2.wide[ctrl.treat, light],
    DRratio = (dark - AUC.ch2.wide[ctrl.treat, dark])/AUC.ch2.wide[ctrl.treat, dark]
    )
  ]
some2[ctrl.treat, "Treatment"] <- paste(some2[ctrl.treat, "Treatment"], "(Ctrl)")
knitr::kable(some2, caption = "Comparing GF to CVZ") %>% 
  kable_styling(bootstrap_options = "striped")
```

```{r lpr-by-plate-plot, fig.cap="LPR results from epoch 2 by Treatment and Plate. Yellow line indicates light cycle (vs dark cycle)"}
hcal5 <- hcal3[, .(h.sec = sum(ave.h)), by = c("Treatment", "plate", "sec")]
hcal5[
  , 
  plate.id.new := factor(
    mgsub(
      c("18099", "18100", "18101", "18102", "18103", "18104"),
      c("GF.1", "GF.2", "CVZ.1", "CVZ.2", "CV.1", "CV.2"),
      plate
    ),
    levels = c("GF.1", "GF.2", "CVZ.1", "CVZ.2", "CV.1", "CV.2")
  )
  ]

ggplot(hcal5, aes(sec, h.sec, colour = plate.id.new)) +
  geom_path(lwd = 1.2, aes(group = plate)) +
  geom_segment(x = 0, y = 2.5, xend = 150, yend = 2.5, color = "yellow") + 
  scale_color_brewer(name = "Treatment", palette = "Paired") +
  labs(x = "Time", y = "Differential Entropy") + 
  theme(legend.position = "top")
```
